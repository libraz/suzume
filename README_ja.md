# Suzume

C++17 製の軽量日本語形態素解析ライブラリ。

## これは車輪の再発明か？

部分的にはそうだが、目的・制約・設計思想が既存とは明確に異なる。

日本語形態素解析は ChaSen / MeCab 以降、何度も再実装されてきた分野であり、「再発明そのもの」が問題になる領域ではない。本プロジェクトは、現代的な制約と用途を前提に、形態素解析の役割を再定義した実装である。

### 既存手法の前提

従来の解析器は以下を暗黙の前提としている：

- 大規模辞書が常に存在する
- 辞書に載っている語が「正解」である
- 未知語は例外であり、なるべく出さない
- 接続表（品詞遷移コスト）が解析の中心

これらは新聞・学術用途では合理的だったが、Web / WASM / 新語過多 / タグ生成といった用途では前提が崩れている。

### Suzume の前提

- 辞書は最初から完璧ではない
- 新語・固有名詞・複合語が大量に出現する
- 辞書は後から育てるもの
- 解析結果は「意味処理」の前段に過ぎない
- WASM や軽量環境で動く必要がある

つまり **「辞書前提」ではなく「辞書成長前提」** の設計。

## 何が違うのか

| 従来 | Suzume |
|------|--------|
| 辞書一致 ≒ 正解 | 辞書一致 = 加点要素のひとつ |
| 未知語 = 失敗 | 未知語 = 通常ケース |
| 局所判断の積み重ね | 全候補生成 → Viterbi で大域最適 |
| 巨大接続表が必須 | 表層特徴 + 軽量 POS bigram |
| ネイティブ実行前提 | WASM ファースト |

### 技術的ポイント

**辞書を「正解」ではなく「特徴量」として扱う**

辞書が少なくても解析は壊れない。辞書を足すほど精度が自然に上がる。辞書不足による誤解析が致命傷にならない。

**分かち書きを逐次確定しない**

結合候補・分割候補をすべて並べてから、Viterbi で全体最適を選ぶ。複合語・新語・長い名詞列に対して、後戻り不能な誤判定を避けられる。

**接続表に依存しない**

品詞遷移の巨大な接続表を前提にしない。表層特徴・文脈特徴・軽量な品詞 bigram による feature-based decoding を採用。実装が単純、WASM で扱える、辞書増減による破綻が起きにくい。

**未知語を例外として扱わない**

文字種連続・漢字連接・カタカナ新語・英数字混在語を積極的に候補生成し、辞書語と同列に評価する。

## 想定ユースケース

- 検索インデックス生成
- タグ生成・分類
- 辞書育成パイプライン
- Web / WASM 上での日本語解析
- 新語・固有名詞が多いドメイン

## 機能

- **外部依存ゼロ**: ICU 不要のカスタム UTF-8 正規化
- **Trie ベース辞書**: Double-Array Trie によるコア＋ユーザー辞書
- **Viterbi**: ラティスベースの大域最適化
- **動詞活用**: 800 以上の活用パターン（五段・一段・サ変・カ変）
- **バイナリ辞書**: 効率的なシリアライズ形式
- **CLI**: 対話モード、JSON/TSV 出力、辞書管理

## ビルド

```bash
make          # ビルド
make test     # テスト実行
make clean    # クリーン
make rebuild  # クリーン＆リビルド
```

## 使い方

### ライブラリ

```cpp
#include "suzume.h"

suzume::Suzume analyzer;
auto result = analyzer.analyze("私は東京に住んでいます");

for (const auto& morpheme : result) {
    std::cout << morpheme.surface << "\t"
              << core::posToString(morpheme.pos) << "\t"
              << morpheme.lemma << std::endl;
}
```

### CLI

```bash
# 形態素解析
suzume-cli "私は東京に住んでいます"

# JSON 出力
suzume-cli analyze -f json "テキスト"

# 辞書コンパイル
suzume-cli dict compile user.tsv

# 対話モード
suzume-cli -i
```

### 出力例

```
私           NOUN      私
は           PARTICLE  は
東京         NOUN      東京
に           PARTICLE  に
住んでいます  VERB      住む
```

## 辞書

```
data/
├── core/           # ソース TSV（バージョン管理対象）
├── user/           # ユーザー TSV
├── core.dic        # コンパイル済みコア辞書（自動読込）
└── user.dic        # コンパイル済みユーザー辞書（自動読込）
```

自動読込の検索順序:
`$SUZUME_DATA_DIR` → `./data/` → `~/.suzume/` → `/usr/local/share/suzume/` → `/usr/share/suzume/`

## ライセンス

MIT License
